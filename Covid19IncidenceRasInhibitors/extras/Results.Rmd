---
params:
    save: NULL #"first.Rda"
    load: "first.Rda"
    completeReload: false
# bibliography: CohortDefinition.bib
# csl: nature-publishing-group-vancouver.csl
output:
  pdf_document:
    keep_tex: true
    md_extensions: +raw_attribute
    latex_engine: xelatex
mainfont: Arial
    #citation_package: natbib
    #rticles::sim_article
fontsize: 10pt
geometry: margin=1in
classoptions: doublespace
longtable: true
header-includes:
  - \usepackage[numbers,sort&compress]{natbib}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage[table]{xcolor}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{caption}
  - \usepackage{rotating}
  - \usepackage{multirow}
  - \usepackage{mwe,tikz}
  - \usepackage[percent]{overpic}
  - \usepackage{enumitem}
  - \usepackage{mas_fun}
  - \usepackage{hyperref}
---
```{r, echo=FALSE, warning=FALSE, message=FALSE}
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)
knitr::knit_hooks$set(document = function(x) {sub('\\usepackage[]{color}', '\\usepackage[table]{xcolor}', x, fixed = TRUE)})
library(dplyr)
library(tidyr)
library(xtable)
```

\centerline{{\Huge Results: Incidence}}

<!-- \captionsetup[table]{name=Supplementary Table} -->
<!-- \captionsetup[figure]{name=Supplementary Figure} -->
\captionsetup{labelfont=bf}

# Cohorts

```{r, echo=FALSE}
cohorts <- read.csv(file = system.file("settings", "CohortsToCreate.csv", package = "Covid19IncidenceRasInhibitors")) %>% select(cohortId, shinyName)

aceMonoId <- cohorts %>% filter(shinyName == "ACE mono") %>% select(cohortId) %>% pull()
arbMonoId <- cohorts %>% filter(shinyName == "ARB mono") %>% select(cohortId) %>% pull()
aceArbMonoId <- cohorts %>% filter(shinyName == "ACE/ARB mono") %>% select(cohortId) %>% pull()
ccbThzMonoId <- cohorts %>% filter(shinyName == "CCB/THZ mono") %>% select(cohortId) %>% pull()

aceComboId <- cohorts %>% filter(shinyName == "ACE +combo") %>% select(cohortId) %>% pull()
arbComboId <- cohorts %>% filter(shinyName == "ARB +combo") %>% select(cohortId) %>% pull()
aceArbComboId <- cohorts %>% filter(shinyName == "ACE/ARB +combo") %>% select(cohortId) %>% pull()
ccbThzComboId <- cohorts %>% filter(shinyName == "CCB/THZ +combo") %>% select(cohortId) %>% pull()

ccbMonoId <- cohorts %>% filter(shinyName == "CCB mono") %>% select(cohortId) %>% pull()
thzMonoId <- cohorts %>% filter(shinyName == "THZ mono") %>% select(cohortId) %>% pull()
ccbComboId <- cohorts %>% filter(shinyName == "CCB +combo") %>% select(cohortId) %>% pull()
thzComboId <- cohorts %>% filter(shinyName == "THZ +combo") %>% select(cohortId) %>% pull()

covidNarrowId <- cohorts %>% filter(shinyName == "COVID-19 narrow") %>% select(cohortId) %>% pull()
covidBroadId <- cohorts %>% filter(shinyName == "COVID-19 broad") %>% select(cohortId) %>% pull()

pnaId <- cohorts %>% filter(shinyName == "Pneumonia") %>% select(cohortId) %>% pull()
adverseId <- cohorts %>% filter(shinyName == "Adverse event") %>% select(cohortId) %>% pull()

prettyNames <- data.frame(
  cohortId = c(aceMonoId, arbMonoId, aceArbMonoId, ccbMonoId, thzMonoId, ccbThzMonoId,
               aceComboId, arbComboId, aceArbComboId, ccbComboId, thzComboId, ccbThzComboId),
  cohortName = c("ACE", "ARB", "ACE/ARB", "CCB", "THZ", "CCB/THZ",
                 "ACE+", "ARB+", "ACE/ARB+", "CCB+", "THZ+", "CCB/THZ+"))

primaryAnalysisId <- 5 # Full stratified PS
```


# Sample sizes

```{r, echo=FALSE, warning=FALSE, message=FALSE}

sidiapDir <- "/Users/msuchard/Dropbox/Projects/Covid19EstimationRasInhibitors/SIDIAP"
cuimcDir <- "/Users/msuchard/Dropbox/Projects/Covid19EstimationRasInhibitors/CUIMC"
studyFolder <- "/Users/msuchard/Dropbox/Projects/Covid19EstimationRasInhibitors"

dataFolder <- file.path(sidiapDir, "shinyData")
databaseId <- "SIDIAP"

makeSampleSizeTable <- function(databaseId, 
                                dataFolder,
                                databaseOrder = 1) {
  cmResults <- readRDS(file = file.path(dataFolder, paste0("cohort_method_result_", databaseId, ".rds")))
  colnames(cmResults) <- SqlRender::snakeCaseToCamelCase(colnames(cmResults))
  alpha <- 0.05
  power <- 0.8
  z1MinAlpha <- qnorm(1 - alpha/2)
  zBeta <- -qnorm(1 - power)
  pA <- cmResults$targetSubjects/(cmResults$targetSubjects + cmResults$comparatorSubjects)
  pB <- 1 - pA
  totalEvents <- abs(cmResults$targetOutcomes) + (cmResults$comparatorOutcomes)
  cmResults$mdrr <- exp(sqrt((zBeta + z1MinAlpha)^2/(totalEvents * pA * pB)))
  cmResults$targetYears <- cmResults$targetDays/365.25
  cmResults$comparatorYears <- cmResults$comparatorDays/365.25
  
  cmResults <- cmResults %>% filter(analysisId == primaryAnalysisId, outcomeId == covidNarrowId)
  
  table <- rbind(
    # cmResults %>% filter(targetId == aceArbMonoId, comparatorId == ccbThzMonoId) %>% mutate(targetId = "ACE/ARB (m)", comparatorId = "CCB/THZ (m)"),
    # cmResults %>% filter(targetId == aceMonoId, comparatorId == arbMonoId) %>% mutate(targetId = "ACE (m)", comparatorId = "ARB (m)"),
    # cmResults %>% filter(targetId == aceArbComboId, comparatorId == ccbThzComboId) %>% mutate(targetId = "ACE/ARB (c)", comparatorId = "CCB/THZ (c)"),
    # cmResults %>% filter(targetId == aceComboId, comparatorId == arbComboId) %>% mutate(targetId = "ACE (c)", comparatorId = "ARB (c)")  
    cmResults %>% filter(targetId == aceArbMonoId, comparatorId == ccbThzMonoId) %>% mutate(targetId = "ACE/ARB (m)", comparatorId = "CCB/THZ (m)", order = 1),
    cmResults %>% filter(targetId == aceArbComboId, comparatorId == ccbThzComboId) %>% mutate(targetId = "ACE/ARB (c)", comparatorId = "CCB/THZ (c)", order = 2),
    cmResults %>% filter(targetId == aceMonoId, comparatorId == arbMonoId) %>% mutate(targetId = "ACE (m)", comparatorId = "ARB (m)", order = 3),
    cmResults %>% filter(targetId == aceComboId, comparatorId == arbComboId) %>% mutate(targetId = "ACE (c)", comparatorId = "ARB (c)", order = 4),
    cmResults %>% filter(targetId == aceMonoId, comparatorId == ccbThzMonoId) %>% mutate(targetId = "ACE (m)", comparatorId = "CCB/THZ (m)", order = 5),
    cmResults %>% filter(targetId == aceComboId, comparatorId == ccbThzComboId) %>% mutate(targetId = "ACE (c)", comparatorId = "CCB/THZ (c)", order = 6),
    cmResults %>% filter(targetId == arbMonoId, comparatorId == ccbThzMonoId) %>% mutate(targetId = "ARB (m)", comparatorId = "CCB/THZ (m)", order = 7),
    cmResults %>% filter(targetId == arbComboId, comparatorId == ccbThzComboId) %>% mutate(targetId = "ARB (c)", comparatorId = "CCB/THZ (c)", order = 8)    
  ) %>% mutate (databaseId = databaseId, databaseOrder = databaseOrder) %>% 
    select(targetId, comparatorId, databaseId, targetSubjects, comparatorSubjects, targetYears, comparatorYears, targetOutcomes, comparatorOutcomes, mdrr, order, databaseOrder)
  
  table$targetSubjects <- formatC(table$targetSubjects, big.mark = ",", format = "d")
  table$comparatorSubjects <- formatC(table$comparatorSubjects, big.mark = ",", format = "d")
  table$targetYears <- formatC(table$targetYears, big.mark = ",", format = "d")
  table$comparatorYears <- formatC(table$comparatorYears, big.mark = ",", format = "d")
  table$targetOutcomes <- formatC(table$targetOutcomes, big.mark = ",", format = "d")
  table$comparatorOutcomes <- formatC(table$comparatorOutcomes, big.mark = ",", format = "d")
  # table$targetIr <- sprintf("%.2f", table$targetIr)
  # table$comparatorIr <- sprintf("%.2f", table$comparatorIr)
  table$mdrr <- sprintf("%.2f", table$mdrr)
  table$targetSubjects <- gsub("^-", "<", table$targetSubjects)
  table$comparatorSubjects <- gsub("^-", "<", table$comparatorSubjects)
  table$targetOutcomes <- gsub("^-", "<", table$targetOutcomes)
  table$comparatorOutcomes <- gsub("^-", "<", table$comparatorOutcomes)
  # table$targetIr <- gsub("^-", "<", table$targetIr)
  # table$comparatorIr <- gsub("^-", "<", table$comparatorIr)
  return(table)
}

tableSidiap <- makeSampleSizeTable(databaseId = "SIDIAP", dataFolder = file.path(sidiapDir, "shinyData"), databaseOrder = 1)
tableCuimc <- makeSampleSizeTable(databaseId = "CUIMC", dataFolder = file.path(cuimcDir, "shinyData"), databaseOrder = 2)

table <- rbind(tableSidiap, tableCuimc) %>% arrange(order, databaseOrder) %>% 
  mutate(targetId = "", comparatorId = "") %>% select(-order, -databaseOrder)
```

\begin{table}[H]
 \caption{Population size, total exposure time and COVID-19 diagnoses for ACEI, ARB and CCB/THZ monotherapy and in-combination user target (T) and comparator (C) cohorts.}
  \rowcolors{2}{gray!6}{white}
  \centering{
  \begin{tabular}{p{-2em}p{-2em}rrrrrrrr}
    \hiderowcolors
    \toprule
    &  &  & \multicolumn{2}{c}{Patients} & \multicolumn{2}{c}{Time (years)} & \multicolumn{2}{c}{Events} \\
    \cmidrule(lr){4-5} \cmidrule(lr){6-7} \cmidrule(lr){8-9}
    &  &
    & \multicolumn{1}{c}{T} & \multicolumn{1}{c}{C}
    & \multicolumn{1}{c}{T} & \multicolumn{1}{c}{C}
    & \multicolumn{1}{c}{T} & \multicolumn{1}{c}{C} 
    & MDRR \\
    \midrule \showrowcolors
```{r, echo=FALSE, results="asis"}
print(xtable(table, format = "latex"),
      include.rownames = FALSE,
      include.colnames = FALSE,
      hline.after = NULL,
      only.contents = TRUE,
      add.to.row = list(
        pos = as.list(c(0,2,4,6,8,10,12,14)),
        command = c(
          "                       \\multicolumn{9}{l}{ACE/ARB vs CCB/THZ} \\\\ & \\multicolumn{9}{l}{Monotherapy}  \\\\",
          "                        & \\multicolumn{8}{l}{+ Combination} \\\\",
          "\\rowcolor{white} \\\\ \\multicolumn{9}{l}{ACE vs ARB} \\\\ & \\multicolumn{9}{l}{Monotherapy}  \\\\",
          "                        & \\multicolumn{8}{l}{+ Combination} \\\\",
          "\\rowcolor{white} \\\\ \\multicolumn{9}{l}{ACE vs CCB/THZ} \\\\ & \\multicolumn{9}{l}{Monotherapy}  \\\\",
          "                        & \\multicolumn{8}{l}{+ Combination} \\\\",
          "\\rowcolor{white} \\\\ \\multicolumn{9}{l}{ARB vs CCB/THZ} \\\\ & \\multicolumn{9}{l}{Monotherapy}  \\\\",
          "                        & \\multicolumn{8}{l}{+ Combination} \\\\"
          )
      ),
      sanitize.text.function = identity)
```
  \bottomrule
  \end{tabular}
  }
\end{table}   


```{r, echo=FALSE}
source(system.file("shiny", "EvidenceExplorer", "PlotsAndTables.R",
                   package = "Covid19IncidenceRasInhibitors"))
# source(system.file("shiny", "EvidenceExplorer", "DataPulls.R",
#                    package = "Covid19IncidenceRasInhibitors"))
```

```{r, echo=FALSE, results="asis", cache=FALSE, warning=FALSE}

getCovariateBalance <- function(connection,
                                targetId,
                                comparatorId,
                                databaseId,
                                analysisId,
                                covariate,
                                dataFolder,
                                outcomeId = NULL) {
  file <- sprintf("covariate_balance_t%s_c%s_%s.rds", targetId, comparatorId, databaseId)
  balance <- readRDS(file.path(dataFolder, file))
  colnames(balance) <- SqlRender::snakeCaseToCamelCase(colnames(balance))
  balance <- balance[balance$analysisId == analysisId & balance$outcomeId == outcomeId, ]
  balance <- merge(balance, covariate[covariate$databaseId == databaseId & covariate$analysisId == analysisId, 
                                      c("covariateId", "covariateAnalysisId", "covariateName")])
  balance <- balance[ c("covariateId",
                        "covariateName",
                        "covariateAnalysisId", 
                        "targetMeanBefore", 
                        "comparatorMeanBefore", 
                        "stdDiffBefore", 
                        "targetMeanAfter", 
                        "comparatorMeanAfter",
                        "stdDiffAfter")]
  colnames(balance) <- c("covariateId",
                         "covariateName",
                         "analysisId",
                         "beforeMatchingMeanTreated",
                         "beforeMatchingMeanComparator",
                         "beforeMatchingStdDiff",
                         "afterMatchingMeanTreated",
                         "afterMatchingMeanComparator",
                         "afterMatchingStdDiff")
  balance$absBeforeMatchingStdDiff <- abs(balance$beforeMatchingStdDiff)
  balance$absAfterMatchingStdDiff <- abs(balance$afterMatchingStdDiff)
  return(balance)
}


blend <- function(databaseIds,
                                     targetId,
                                     comparatorId,
                                     dataFolders,
                                     outcomeId = covidNarrowId) {


  covariate1 <- readRDS(file.path(dataFolders[1], paste0("covariate_", databaseIds[1], ".rds")))
  colnames(covariate1) <- SqlRender::snakeCaseToCamelCase(colnames(covariate1))

  balance1 <- getCovariateBalance(NULL, targetId, comparatorId, databaseId = databaseIds[1], analysisId = primaryAnalysisId,
                                  outcomeId = outcomeId,
                                  covariate = covariate1, dataFolder = dataFolders[1])

  covariate2 <- readRDS(file.path(dataFolders[2], paste0("covariate_", databaseIds[2], ".rds")))
  colnames(covariate2) <- SqlRender::snakeCaseToCamelCase(colnames(covariate2))

  balance2 <- getCovariateBalance(NULL, targetId, comparatorId, databaseId = databaseIds[2], analysisId = primaryAnalysisId,
                                  outcomeId = outcomeId,
                                  covariate = covariate2, dataFolder = dataFolders[2])
  
    specifications <- read.csv(system.file("shiny", "EvidenceExplorer", "Table1Specs.csv",
                                      package = "Covid19IncidenceRasInhibitors"), stringsAsFactors = FALSE)


  table1 <- prepareTable1(balance1,pathToCsv = system.file("shiny", "EvidenceExplorer", "Table1Specs.csv",
                                      package = "Covid19IncidenceRasInhibitors"))

  table1 <- table1[3:nrow(table1),]
  colnames(table1) <- c("id","b","c","d","e","f","g")

  table2 <- prepareTable1(balance2,pathToCsv = system.file("shiny", "EvidenceExplorer", "Table1Specs.csv",
                                      package = "Covid19IncidenceRasInhibitors"))

  table2 <- table2[3:nrow(table2),]
  colnames(table2) <- c("id","b","c","d","e","f","g")

  table <- table2
  
  table1$order <- c(1:nrow(table1))
  table2$order <- c(1:nrow(table2))

  return(list(table1, table2, specifications,
              numCovariates = c(nrow(balance1), nrow(balance2))))
}

 tmp <- blend(aceArbMonoId, ccbThzMonoId,
                          databaseIds = c("SIDIAP", "CUIMC"),
                          dataFolders = c(dataFolder = file.path(sidiapDir, "shinyData"),
                                          dataFolder = file.path(cuimcDir, "shinyData")))
 
 numCovariates <- tmp$numCovariates
 names(numCovariates) <- c("SIDIAP", "CUIMC")
 
 t2 <- full_join(tmp[[1]], tmp[[2]], by = "id")
 
names <- c(
  "Age group",
  "    15-19",
  "    20-24",
  "    25-29",
  "    30-34",
  "    35-39",
  "    40-44",
  "    45-49",
  "    50-54",
  "    55-59",
  "    60-64",
  "    65-69",
  "    70-74",
  "    75-79",
  "    80-84",
  "    85-89",
  "    90-94",
  "    95-99",
  "    00-04",
  "Gender: female",
  "Medical history: General",
  "    Acute respiratory disease",
  "    Attention deficit hyperactivity disorder",
  "    Chronic liver disease",
  "    Chronic obstructive lung disease",
  "    Crohn's disease",
  "    Dementia",
  "    Depressive disorder",
  "    Diabetes mellitus",
  "    Gastroesophageal reflux disease",
  "    Gastrointestinal hemorrhage",
  "    Human immunodeficiency virus infection",
  "    Hyperlipidemia",
  "    Hypertensive disorder",
  "    Lesion of liver",
  "    Obesity",
  "    Osteoarthritis",
  "    Pneumonia",
  "    Psoriasis",
  "    Renal impairment",
  "    Rheumatoid arthritis",
  "    Schizophrenia",
  "    Ulcerative colitis",
  "    Urinary tract infectious disease",
  "    Viral hepatitis C",
  "    Visual system disorder",
  "Medical history: Cardiovascular disease",
  "    Atrial fibrillation",
  "    Cerebrovascular disease",
  "    Coronary arteriosclerosis",  
  "    Heart disease",
  "    Heart failure",
  "    Ischemic heart disease",
  "    Peripheral vascular disease",
  "    Pulmonary embolism",
  "    Venous thrombosis",
  "Medical history: Neoplasms",
  "    Hematologic neoplasm",
  "    Malignant lymphoma",
  "    Malignant neoplasm of anorectum",
  "    Malignant neoplastic disease",
  "    Malignant tumor of breast",
  "    Malignant tumor of colon",
  "    Malignant tumor of lung",
  "    Malignant tumor of urinary bladder",
  "    Primary malignant neoplasm of prostate",
  "Medication use",
  "    Agents acting on the renin-angiotensin system",
  "    Antibacterials for systemic use",
  "    Antidepressants",
  "    Antiepileptics",
  "    Antiinflammatory and antirheumatic products",
  "    Antineoplastic agents",
  "    Antipsoriatics",
  "    Antithrombotic agents",
  "    Beta blocking agents",
  "    Calcium channel blockers",
  "    Diuretics",  
  "    Drugs for acid related disorders",
  "    Drugs for obstructive airway diseases",
  "    Drugs used in diabetes",
  "    Immunosuppressants",
  "    Lipid modifying agents",  
  "    Opioids",
  "    Psycholeptics",
  "    Psychostimulants, agents used for adhd and nootropics",
  "Race",
  "    race = Asian",
  "    race = Other Race",
  "    race = White",
  "    race = Unknown",
  "    race = American Indian or Alaska Native",
  "    race = Asian Indian",
  "    race = Chinese",
  "    race = Filipino",
  "    race = Korean",
  "    race = Laotian",
  "    race = Vietnamese",
  "    race = Other Pacific Islander",
  "Ethnicity",
  "    ethnicity = Hispanic or Latino",
  "    ethnicity = Not Hispanic or Latino")

orders <- c(1:length(names))
tableOrder <- data.frame(id = names,
                         order = orders)

t3 <- full_join(t2, tableOrder, by = "id") %>% arrange(order) %>% select(-order.x, order.y, order)
t3[is.na(t3)] <- ""

targetId <- aceArbMonoId
comparatorId <- ccbThzMonoId
databaseId = "SIDIAP and CUIMC" 

# makeCharacteristicsTable <- function(databaseId,
#                                      targetId,
#                                      comparatorId,
#                                      dataFolder,
#                                      outcomeId = covidNarrowId) {
# 
# covariate <- readRDS(file.path(dataFolder, paste0("covariate_", databaseId, ".rds")))
# colnames(covariate) <- SqlRender::snakeCaseToCamelCase(colnames(covariate))
# 
# balance <- getCovariateBalance(NULL, targetId, comparatorId, databaseId = databaseId, analysisId = primaryAnalysisId, outcomeId = outcomeId, 
#                                covariate = covariate, dataFolder = dataFolder)
# 
#   table <- prepareTable1(balance,pathToCsv = system.file("shiny", "EvidenceExplorer", "Table1Specs.csv", 
#                                       package = "Covid19IncidenceRasInhibitors"))
#   table <- table[3:nrow(table),]




#out <- lapply(balances_strat, function(tmp) {

  scale <- 0.64
  header <- readr::read_file("Table1TopDouble.tex")
  # targetName <- (firstLineClasses %>% filter(cohortId == tmp$targetId))$shortName
  # comparatorName <- (firstLineClasses %>% filter(cohortId == tmp$comparatorId))$shortName

  # if (!(targetName == "THZ" && comparatorName == "ACEi")) {

  targetName <- cohorts %>% filter(cohortId == targetId) %>% select(shinyName) %>% pull
  comparatorName <- cohorts %>% filter(cohortId == comparatorId) %>% select(shinyName) %>% pull
  title <- sub(pattern = "Patient demographics",
               replacement = paste0("Baseline patient characteristcs for ", targetName," (T) and ", comparatorName, " (C) prevalent-users in the ", databaseId, " data source"),
               x = header)

  title <- sub("0.5\\\\textwidth", paste0(scale, "\\\\textwidth"), x = title)
  title <- sub("-0.5em", "+0.5em", x = title)

  title <- sub("% Extra row",
               paste0("& \\\\multicolumn{3}{c}{$N$ = XXX} & \\\\multicolumn{3}{c}{$N$ = XXX} \\\\\\\\"),
               # , "\\\\\\\\ \n",
               #        "\& \\\\multicolumn{3}{c}{Before stratification} \& \\\\multicolumn{3}{c}{After stratification} "),
               x = title)
  
  # if (targetName == "THZ" && comparatorName == "ARB") {
  #   title <- sub("table}", "table}[H]\\\\ContinuedFloat*", title)
  # } else {
  #   title <- sub("table}", "table}[H]\\\\ContinuedFloat", title)
  # }

  cat(title)

  # table <- prepareTable1(tmp$balance, pathToCsv = file.path("..", "Table1Specs.csv"))
  # table <- prepareTable1(balance,pathToCsv = system.file("shiny", "EvidenceExplorer", "Table1Specs.csv", 
  #                                     package = "Covid19IncidenceRasInhibitors"))
  
  
  
  # table <- table[3:nrow(table),]
  table <- t3 %>% select(-order.y, -order)

  print(xtable(table, format = "latex", align = c("l","l","r","r","r","r","r","r","r","r","r","r","r","r")),
        include.rownames = FALSE,
        include.colnames = FALSE,
        hline.after = NULL,
        only.contents = TRUE,
        add.to.row = list(pos = list(nrow(table)), command = c("\\bottomrule")),
        sanitize.text.function = identity)

  footer <- readr::read_file("Table1BottonDouble.tex")
  cat(footer)
#}

 # tmp <- makeCharacteristicsTable(aceArbMonoId, ccbThzMonoId, 
 #                          databaseIds = c("SIDIAP", "CUIMC"),
 #                          dataFolders = c(dataFolder = file.path(sidiapDir, "shinyData"),
 #                                          dataFolder = file.path(cuimcDir, "shinyData")))

# makeCharacteristicsTable(aceArbMonoId, ccbThzMonoId,   databaseId = "SIDIAP", dataFolder = file.path(sidiapDir, "shinyData"))
# makeCharacteristicsTable(aceArbMonoId, ccbThzMonoId,   databaseId = "CUIMC", dataFolder = file.path(cuimcDir, "shinyData"))

```


```{r, echo=FALSE}

  # }

  # plot <- plotCovariateBalanceScatterPlot(tmp$balance, labels = FALSE,
  #                                         beforeLabel = "Before stratification", afterLabel = "After stratification")
  #                                         # beforeLabel = "", afterLabel = "")
  #   suppressMessages(ggplot2::ggsave(paste0("scatter_", targetName, "_", comparatorName, ".pdf"), plot,
  #                                    width = 3, height = 3, units = "in"))
# })

# text <- prepareTable1(balance,
#               output = "latex",
#               pathToCsv = system.file("shiny", "EvidenceExplorer", "Table1Specs.csv", 
#                                       package = "Covid19IncidenceRasInhibitors"))


# function(balance,
#                           beforeLabel = "Before stratification",
#                           afterLabel = "After stratification",
#                           targetLabel = "Target",
#                           comparatorLabel = "Comparator",
#                           percentDigits = 1,
#                           stdDiffDigits = 2,
#                           output = "latex",
#                           pathToCsv = "Table1Specs.csv") {

```

## Numbers of covariates

```{r}
numCovariates
```

```{r, echo=FALSE}

tcs <- list(
  list(aceArbMonoId, ccbThzMonoId),
  list(aceArbComboId, ccbThzComboId),

  list(aceMonoId, arbMonoId),
  list(aceComboId, arbComboId),
  
  list(aceMonoId, ccbThzMonoId),
  list(aceComboId, ccbThzComboId),
  
  list(arbMonoId, ccbThzMonoId),
  list(arbComboId, ccbThzComboId)
)
tcs <- lapply(tcs, function(x) { names(x) <- c("targetId", "comparatorId"); return(x) })

outcomesOfInterest <- Covid19IncidenceRasInhibitors:::getOutcomesOfInterest()

databaseId <- "SIDIAP"
cmResults <- readRDS(file.path(studyFolder, databaseId, "shinyData", sprintf("cohort_method_result_%s.rds", databaseId)))
colnames(cmResults) <- SqlRender::snakeCaseToCamelCase(colnames(cmResults))
cmResultsSidiap <- cmResults %>% filter(outcomeId %in% outcomesOfInterest, analysisId == primaryAnalysisId)

databaseId <- "CUIMC"
cmResults <- readRDS(file.path(studyFolder, databaseId, "shinyData", sprintf("cohort_method_result_%s.rds", databaseId)))
colnames(cmResults) <- SqlRender::snakeCaseToCamelCase(colnames(cmResults))
cmResultsCuimc <- cmResults %>% filter(outcomeId %in% outcomesOfInterest, analysisId == primaryAnalysisId)

cmResults <- rbind(cmResultsSidiap, cmResultsCuimc)

table <- do.call(
  "rbind",
  lapply(tcs, function(tc) {
    cmResults %>% filter(targetId == tc$targetId, comparatorId == tc$comparatorId) %>%
      left_join(prettyNames, by = c("targetId" = "cohortId")) %>% rename(targetName = cohortName) %>%
      left_join(prettyNames, by = c("comparatorId" = "cohortId")) %>% rename(comparatorName = cohortName) %>%
      mutate(ci = sprintf("(%1.2f - %1.2f)", ci95Lb, ci95Ub),
             calibratedCi = sprintf("(%1.2f - %1.2f)", calibratedCi95Lb, calibratedCi95Ub)) %>%
      select(targetName, comparatorName, databaseId, outcomeId, 
             #rr, ci, p, 
             calibratedRr, calibratedCi, calibratedP, calibratedCi95Lb, calibratedCi95Ub)
  }))
```

\begin{table}[H]
 \caption{COVID-19 (narrow) diagnosis risk. We calibrated hazard ratios (HRs) and their 95\% confidence intervals (CIs) across data sources.}
  \rowcolors{2}{gray!6}{white}
  \centering{
  \begin{tabular}{p{-2em}p{-2em}lrrr}
    \hiderowcolors
    \toprule
     & 
    & & \multicolumn{1}{c}{HR} & \multicolumn{1}{c}{95\% CI} & \multicolumn{1}{c}{$p$} \\
    \midrule \showrowcolors
```{r, echo=FALSE, results="asis"}
print(xtable(table %>% filter(outcomeId == covidNarrowId) %>% 
               select(-outcomeId, -calibratedCi95Lb, -calibratedCi95Ub) %>%
               mutate(targetName = "", comparatorName = ""), 
             format = "latex"),
      include.rownames = FALSE,
      include.colnames = FALSE,
      hline.after = NULL,
      only.contents = TRUE,
 add.to.row = list(
        pos = as.list(c(0,2,4,6,8,10,12,14)),
        command = c(
          "                       \\multicolumn{6}{l}{ACE/ARB vs CCB/THZ} \\\\ & \\multicolumn{5}{l}{Monotherapy}  \\\\",
          "                        & \\multicolumn{5}{l}{+ Combination} \\\\",
          "\\rowcolor{white} \\\\ \\multicolumn{6}{l}{ACE vs ARB} \\\\ & \\multicolumn{5}{l}{Monotherapy}  \\\\",
          "                        & \\multicolumn{5}{l}{+ Combination} \\\\",
          "\\rowcolor{white} \\\\ \\multicolumn{6}{l}{ACE vs CCB/THZ} \\\\ & \\multicolumn{5}{l}{Monotherapy}  \\\\",
          "                        & \\multicolumn{5}{l}{+ Combination} \\\\",
          "\\rowcolor{white} \\\\ \\multicolumn{6}{l}{ARB vs CCB/THZ} \\\\ & \\multicolumn{5}{l}{Monotherapy}  \\\\",
          "                        & \\multicolumn{5}{l}{+ Combination} \\\\"
          )
      ),      
      sanitize.text.function = identity)
```
  \bottomrule
  \end{tabular}
  }
\end{table}

# Pretty figure

```{r, echo=FALSE}

pdf(file = "SixEffect.pdf", height = 6, width = 6)

dbs <- 2

map <- function(index) {
  floor(index / dbs) + 2 * floor(index / (2 * dbs)) + 3 + index
}

tab <- table %>% filter(outcomeId == covidNarrowId) %>%
  mutate(index = row_number() - 1,
         row = map(index))

ymax <- max(tab$row)
 
par(mar = c(1,1,1,1))

plot(0,0, type = "n",
     ylim = c(-3, ymax),
     xlim = c(0, 12), axes = FALSE, ylab = "", xlab = "")

textCex <- 0.6

cohortNames <- c("ACE/ARB vs CCB/THZ", "ACE vs ARB", "ACE vs CCB/THZ", "ARB vs CCB/THZ")
cohortPositions <- (c(1:length(cohortNames)) - 1) * (2 * dbs + 4) + 1
text(x = 0, y = ymax - cohortPositions, labels = cohortNames, pos = 4, cex = textCex)

minorNames <- rep(c("Monotherapy", "+ Combination"), length(cohortNames))
minorTicks <- tab %>% filter(databaseId == "SIDIAP") %>% select(row) %>% pull() - 1
text(x = 0.25, y = ymax - minorTicks, labels = minorNames, pos = 4, cex = textCex)

text(x = 0.5, y = ymax - tab$row, labels = tab$databaseId, pos = 4, cex = textCex)

start <- 3.5
width <- 2
spacer <- 2.4
tick <- 0.1

scaleMin <- 1/4  # -1
scaleMax <- 4    # +1

scale <- function(x) {
  log(x) / (log(scaleMax) - log(scaleMin)) * width
}

clip_min <- function(x) { 
  pmax(x, -width / 2)
}

clip_max <- function(x) {
  pmin(x, +width / 2)
}

clip_rm <- function(x) {
  x[x > width / 2] <- NA
  x[x < -width / 2] <- NA
  x
}

outcomeIds <- c(covidNarrowId, covidBroadId, adverseId, pnaId)
outcomeNames <- c("Narrow", "Broad", "Severe", "PNA")

for (i in 1:4) {
  
  offset <- start + (i - 1) * spacer
  
  rect(xleft = offset + scale(scaleMin),
       xright = offset + scale(scaleMax),
       ytop = ymax - 2,
       ybottom = -0.5,
       col = "grey90", border = NA)
  
  segments(x0 = offset, x1 = offset,
           y0 = -0.5, y1 = ymax - 2, lty = 3)
  
  tab <- table %>% filter(outcomeId == outcomeIds[i]) %>%
    mutate(index = row_number() - 1,
           row = map(index))  
  
  points(x = offset + scale(tab$calibratedRr), y = ymax - tab$row, pch = 20)
  segments(x0 = offset + clip_min(scale(tab$calibratedCi95Lb)),
           x1 = offset + clip_max(scale(tab$calibratedCi95Ub)),
           y0 = ymax - tab$row, y1 = ymax - tab$row)  
  
  segments(x0 = offset + clip_rm(scale(tab$calibratedCi95Lb)),
           x1 = offset + clip_rm(scale(tab$calibratedCi95Lb)),
           y0 = ymax - tab$row + tick,
           y1 = ymax - tab$row - tick)
  
  segments(x0 = offset + clip_rm(scale(tab$calibratedCi95Ub)),
           x1 = offset + clip_rm(scale(tab$calibratedCi95Ub)),
           y0 = ymax - tab$row + tick,
           y1 = ymax - tab$row - tick)  
  
  bt <- -0.75
  
  segments(x0 = offset - width / 2,
           x1 = offset + width / 2,
           y0 = bt, y1 = bt)
  
  marks <- scale(c(1/4, 1/2, 1, 2, 4))
  labels <- c("1/4", "1/2", "1", "2", "4")
  
  segments(x0 = offset + marks,
           x1 = offset + marks,
           y0 = bt,
           y1 = bt - 0.2)
  
  text(x = offset + marks,
       y = bt - 0.1,
       labels = labels,
       pos = 1, cex = textCex)
  
  text(x = offset,
       y = bt - 2,
       labels = outcomeNames[i])
}

invisible(dev.off())

```


\begin{figure}[H]
  \caption{Effect estimates for selected comparisons and all outcomes}
  \centerline{
    \includegraphics[width=0.95\textwidth]{SixEffect}
  }
\end{figure}

# Balance plots

```{r, echo=FALSE, warning=FALSE, message=FALSE}

plotCovariateBalanceScatterPlot <- function(balance, beforeLabel = "Before stratification", afterLabel = "After stratification") {
  limits <- c(min(c(balance$absBeforeMatchingStdDiff, balance$absAfterMatchingStdDiff),
                  na.rm = TRUE),
              max(c(balance$absBeforeMatchingStdDiff, balance$absAfterMatchingStdDiff),
                  na.rm = TRUE))
  theme <- ggplot2::element_text(colour = "#000000", size = 12)
  plot <- ggplot2::ggplot(balance, ggplot2::aes(x = absBeforeMatchingStdDiff, y = absAfterMatchingStdDiff)) +
    ggplot2::geom_point(color = rgb(0, 0, 0.8, alpha = 0.3), shape = 16, size = 2) +
    ggplot2::geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
    ggplot2::geom_hline(yintercept = 0) +
    ggplot2::geom_vline(xintercept = 0) +
    ggplot2::scale_x_continuous(beforeLabel, limits = limits) +
    ggplot2::scale_y_continuous(afterLabel, limits = limits) +
    ggplot2::theme(text = theme)
  
  return(plot)
}

covariate <- readRDS(file.path(studyFolder, "CUIMC", "shinyData", paste0("covariate_", "CUIMC", ".rds")))
colnames(covariate) <- SqlRender::snakeCaseToCamelCase(colnames(covariate))

balanceStrat <- getCovariateBalance(NULL, arbComboId, ccbThzComboId, databaseId = "CUIMC", analysisId = primaryAnalysisId,
                                    outcomeId = covidNarrowId,
                                    covariate = covariate, 
                                    dataFolder = file.path(studyFolder, "CUIMC", "shinyData"))

plotStrat <- plotCovariateBalanceScatterPlot(balanceStrat,
                                             beforeLabel = "Before stratification", 
                                             afterLabel = "After stratification")

balanceMatch <- getCovariateBalance(NULL, arbComboId, ccbThzComboId, databaseId = "CUIMC", analysisId = 6,
                                    outcomeId = covidNarrowId,
                                    covariate = covariate, 
                                    dataFolder = file.path(studyFolder, "CUIMC", "shinyData"))

plotMatch <- plotCovariateBalanceScatterPlot(balanceMatch,
                                             beforeLabel = "Before matching", 
                                             afterLabel = "After matching")

library(ggplot2)
ggsave("plotStratArb.pdf", plot = plotStrat, width = 4, height = 4)
ggsave("plotMatchArb.pdf", plot = plotMatch, width = 4, height = 4)

balanceStratArb <- balanceStrat

balanceStrat <- getCovariateBalance(NULL, aceComboId, arbComboId, databaseId = "CUIMC", analysisId = primaryAnalysisId,
                                    outcomeId = covidNarrowId,
                                    covariate = covariate, 
                                    dataFolder = file.path(studyFolder, "CUIMC", "shinyData"))

plotStrat <- plotCovariateBalanceScatterPlot(balanceStrat,
                                             beforeLabel = "Before stratification", 
                                             afterLabel = "After stratification")

balanceMatch <- getCovariateBalance(NULL, aceComboId, arbComboId, databaseId = "CUIMC", analysisId = 6,
                                    outcomeId = covidNarrowId,
                                    covariate = covariate, 
                                    dataFolder = file.path(studyFolder, "CUIMC", "shinyData"))

plotMatch <- plotCovariateBalanceScatterPlot(balanceMatch,
                                             beforeLabel = "Before matching", 
                                             afterLabel = "After matching")

balanceStratAce <- balanceStrat

library(ggplot2)
ggsave("plotStratAce.pdf", plot = plotStrat, width = 4, height = 4)
ggsave("plotMatchAce.pdf", plot = plotMatch, width = 4, height = 4)

```

\begin{figure}[H]
  \caption{ARB combo vs CCB/THZ combo in CUIMC.}
  \begin{center}
    \includegraphics[width=0.4\textwidth]{plotStratArb} \includegraphics[width=0.4\textwidth]{plotMatchArb}
  \end{center}
\end{figure}

\begin{figure}[H]
  \caption{ACE combo vs ARB combo in CUIMC.}
  \begin{center}
    \includegraphics[width=0.4\textwidth]{plotStratAce} \includegraphics[width=0.4\textwidth]{plotMatchAce}
  \end{center}
\end{figure}

### Info about ARB vs CCB/THZ the extreme values in CUIMC stratification:
```{r}
maxIndex <- which(balanceStratArb$absBeforeMatchingStdDiff == max(
  balanceStratArb$absBeforeMatchingStdDiff))
balanceStratArb[maxIndex,
                c("covariateName", "beforeMatchingMeanTreated", "beforeMatchingMeanComparator")]

```

### Info about ACE vs ARB the extreme values in CUIMC stratification:
```{r}
maxIndex <- which(balanceStratAce$absBeforeMatchingStdDiff > 0.3)
balanceStratAce[maxIndex,
                c("covariateName", "beforeMatchingMeanTreated", "beforeMatchingMeanComparator")]

```


